<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KykyChat</title>
  <style>
    body {
      margin: 0;
      background-color: #FFEB3B; /* jaune banane */
      font-family: Arial, sans-serif;
    }

    .topbar {
      display: flex;
      align-items: center;
      padding: 10px;
      background-color: #128C7E;
      color: white;
    }

    .back-arrow {
      font-size: 24px;
      margin-right: 15px;
      cursor: pointer;
    }

    .group-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      background-image: url('https://i.imgur.com/jXC9fM5.jpeg'); /* à remplacer par ton image */
      background-size: cover;
    }

    .group-info {
      display: flex;
      flex-direction: column;
    }

    .group-name {
      font-weight: bold;
      font-size: 16px;
    }

    .group-sub {
      font-size: 13px;
      color: #e0f2f1;
    }

    .spacer {
      flex-grow: 1;
    }

    .menu {
      font-size: 24px;
      cursor: pointer;
    }
    #messages {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      height: calc(100vh - 120px);
      overflow-y: auto;
    }

    .message {
      max-width: 60%;
      padding: 10px;
      border-radius: 15px;
      position: relative;
      word-wrap: break-word;
    }

    .me {
      align-self: flex-end;
      background-color: #dcf8c6;
    }

    .other {
      align-self: flex-start;
      background-color: white;
    }

    .author {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .timestamp {
      font-size: 12px;
      color: gray;
      margin-top: 4px;
    }

    .bottombar {
      height: 60px;
      display: flex;
      align-items: center;
      padding: 0 10px;
      background-color: #ffffff;
      border-top: 1px solid #ccc;
    }

    #inputMessage {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
      outline: none;
    }

    #sendBtn {
      margin-left: 10px;
      background-color: #25D366;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 50%;
      cursor: pointer;
    }
    .user-popup {
  position: fixed;
  bottom: -100%;
  left: 0;
  width: 100%;
  height: 50%;
  background: white;
  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  box-shadow: 0 -4px 10px rgba(0,0,0,0.3);
  transition: bottom 0.4s ease-in-out;
  z-index: 999;
}

.user-popup.show {
  bottom: 0;
}

.popup-content {
  padding: 20px;
  overflow-y: auto;
  height: 100%;
}

#userList li {
  margin-bottom: 10px;
  font-size: 16px;
}

.admin-badge {
  background: #128C7E;
  color: white;
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 10px;
  margin-left: 6px;
}

  </style>
</head>
<body>
  <div id="userPopup" class="user-popup">
  <div class="popup-content">
    <h3>Utilisateurs inscrits</h3>
    <ul id="userList"></ul>
    <button onclick="toggleUserPopup()">Fermer</button>
  </div>
</div>

  <div class="topbar">
    <div class="back-arrow">&#8592;</div>
    <div class="group-icon"></div>
    <div class="group-info">
      <div class="group-name">La commu des gens</div>
      <div class="group-sub">Mode public. Tout le monde peut acceder au groupe.</div>
    </div>
    <button onclick="window.location.href='info.html'">Infos du groupe</button>
    <div class="spacer"></div>
    <div style="margin-left: auto; cursor: pointer;" onclick="toggleUserPopup()">
  &#8942;
</div>
  </div>
  <div id="messages"></div>
  <div class="bottombar">
    <input type="text" id="inputMessage" placeholder="Écris ton message...">
    <button id="sendBtn">➤</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
  import { getDatabase, ref, onValue, get, child } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
    authDomain: "kykychat-24c7f.firebaseapp.com",
    databaseURL: "https://kykychat-24c7f-default-rtdb.firebaseio.com",
    projectId: "kykychat-24c7f",
    storageBucket: "kykychat-24c7f.appspot.com",
    messagingSenderId: "342562811927",
    appId: "1:342562811927:web:0fed1e1f511c4fddcfec52"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const pseudo = localStorage.getItem("pseudo");
  if (!pseudo) window.location.href = "index.html";

  let userColor = "#000";

  // Récupère la couleur du pseudo
  get(ref(db, "users/" + pseudo)).then(snapshot => {
    const data = snapshot.val();
    if (data && data.color) userColor = data.color;
  });

  const messagesDiv = document.getElementById("messages");
  const input = document.getElementById("inputMessage");
  const sendBtn = document.getElementById("sendBtn");

  // Envoyer un message
  sendBtn.onclick = () => {
    const text = input.value.trim();
    if (!text) return;

    const now = new Date();
    const timestamp = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    const messageData = {
      pseudo,
      color: userColor,
      text,
      time: timestamp
    };

    firebase.database().ref("messages").push(messageData);
    input.value = "";
  };

  // Écoute les nouveaux messages
  firebase.database().ref("messages").on("child_added", snap => {
    const data = snap.val();
    const msg = document.createElement("div");
    msg.innerHTML = `<span style="color:${data.color}; font-weight:bold;">${data.pseudo}</span> : ${data.text} <span style="font-size:12px; color:gray;">${data.time}</span>`;
    messagesDiv.appendChild(msg);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  // === POPUP UTILISATEURS ===

  function toggleUserPopup() {
    const popup = document.getElementById("userPopup");
    const userList = document.getElementById("userList");

    if (popup.classList.contains("open")) {
      popup.classList.remove("open");
      popup.classList.add("close");
    } else {
      popup.classList.remove("close");
      popup.classList.add("open");

      // Rafraîchir la liste des utilisateurs
      get(ref(db, "users")).then(snapshot => {
        userList.innerHTML = ""; // Nettoie la liste
        snapshot.forEach(childSnap => {
          const user = childSnap.val();
          const li = document.createElement("li");

          const isAdmin = user.admin === true;
          li.innerHTML = `
            <span style="color:${user.color || '#000'}; font-weight:bold;">${childSnap.key}</span>
            ${isAdmin ? '<span style="margin-left: 8px; padding: 2px 6px; background-color: #C8E6C9; color: #2E7D32; border-radius: 10px; font-size: 12px;">ADMIN</span>' : ''}
          `;

          userList.appendChild(li);
        });
      });
    }
  }


  </script>
</body>
</html>
