<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>A320 ND</title>
  <style>
    body {
      background-color: black;
      color: #00ff00;
      font-family: monospace;
      margin: 0;
      overflow: hidden;
    }
    #ndContainer {
      position: relative;
      width: 100vmin;
      height: 100vmin;
      margin: auto;
      background: black;
    }
    #ndCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    #inputPanel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border: 1px solid #00ff00;
      z-index: 5;
    }
    #inputPanel input {
      display: block;
      margin-bottom: 5px;
      background: black;
      color: #00ff00;
      border: 1px solid #00ff00;
      padding: 4px;
    }
    #addBtn, #startBtn {
      margin-top: 5px;
      padding: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div id="ndContainer">
  <canvas id="ndCanvas" width="600" height="600"></canvas>
  <div id="inputPanel">
    <div id="waypointInputs">
      <input type="text" placeholder="Waypoint name" class="wp-input" />
    </div>
    <button id="addBtn">+</button>
    <button id="startBtn">Afficher ND</button>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
  authDomain: "kykychat-24c7f.firebaseapp.com",
  databaseURL: "https://kykychat-24c7f-default-rtdb.firebaseio.com",
  projectId: "kykychat-24c7f",
  storageBucket: "kykychat-24c7f.appspot.com",
  messagingSenderId: "342562811927",
  appId: "1:342562811927:web:0fed1e1f511c4fddcfec52"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const canvas = document.getElementById("ndCanvas");
const ctx = canvas.getContext("2d");
let waypoints = [];
let currentPos = { lat: 0, lon: 0, heading: 0 };

function toRadians(deg) {
  return deg * Math.PI / 180;
}
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3; // m
  const φ1 = toRadians(lat1);
  const φ2 = toRadians(lat2);
  const Δφ = toRadians(lat2 - lat1);
  const Δλ = toRadians(lon2 - lon1);
  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
function getBearing(lat1, lon1, lat2, lon2) {
  const y = Math.sin(toRadians(lon2 - lon1)) * Math.cos(toRadians(lat2));
  const x = Math.cos(toRadians(lat1)) * Math.sin(toRadians(lat2)) -
            Math.sin(toRadians(lat1)) * Math.cos(toRadians(lat2)) * Math.cos(toRadians(lon2 - lon1));
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}
function drawND() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const cx = canvas.width / 2;
  const cy = canvas.height;
  const scale = 3; // meters per pixel

  // Draw arc scale
  ctx.strokeStyle = "#00ff00";
  ctx.beginPath();
  ctx.arc(cx, cy, 200, Math.PI, 2*Math.PI);
  ctx.stroke();

  // Draw own aircraft triangle
  ctx.fillStyle = "yellow";
  ctx.beginPath();
  ctx.moveTo(cx, cy - 10);
  ctx.lineTo(cx - 8, cy);
  ctx.lineTo(cx + 8, cy);
  ctx.closePath();
  ctx.fill();

  // Draw waypoints & lines
  let prev = { lat: currentPos.lat, lon: currentPos.lon };
  for (let wp of waypoints) {
    const dist = getDistance(currentPos.lat, currentPos.lon, wp.lat, wp.lon);
    const brg = getBearing(currentPos.lat, currentPos.lon, wp.lat, wp.lon) - currentPos.heading;
    const angle = toRadians(brg);
    const x = cx + Math.sin(angle) * dist / scale;
    const y = cy - Math.cos(angle) * dist / scale;

    // Draw line from prev
    const dist2 = getDistance(prev.lat, prev.lon, wp.lat, wp.lon);
    const brg2 = getBearing(prev.lat, prev.lon, wp.lat, wp.lon) - currentPos.heading;
    const x2 = cx + Math.sin(toRadians(brg2)) * dist2 / scale;
    const y2 = cy - Math.cos(toRadians(brg2)) * dist2 / scale;
    ctx.strokeStyle = "#00ff00";
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(x2, y2);
    ctx.stroke();

    // Draw waypoint circle
    ctx.beginPath();
    ctx.arc(x, y, 5, 0, 2 * Math.PI);
    ctx.stroke();

    // Draw label
    ctx.fillStyle = "#00ff00";
    ctx.fillText(wp.name, x + 5, y - 5);

    prev = wp;
  }
}

function updateGPS() {
  navigator.geolocation.watchPosition(pos => {
    currentPos.lat = pos.coords.latitude;
    currentPos.lon = pos.coords.longitude;
  });
  window.addEventListener("deviceorientation", e => {
    if (e.absolute) currentPos.heading = e.alpha;
  });
}

function loadWaypoints(names) {
  const promises = names.map(name => get(child(ref(db), `waypoints/${name}`)));
  Promise.all(promises).then(snaps => {
    waypoints = snaps.map(snap => ({
      name: snap.key,
      lat: snap.val().lat,
      lon: snap.val().lon
    }));
    setInterval(drawND, 1000);
  });
}

// Add more input fields
addBtn.onclick = () => {
  const input = document.createElement("input");
  input.placeholder = "Waypoint name";
  input.classList.add("wp-input");
  document.getElementById("waypointInputs").appendChild(input);
};

// Start ND
startBtn.onclick = () => {
  const names = [...document.querySelectorAll(".wp-input")].map(i => i.value.trim()).filter(n => n);
  updateGPS();
  loadWaypoints(names);
  document.getElementById("inputPanel").style.display = "none";
};
</script>
</body>
</html>
