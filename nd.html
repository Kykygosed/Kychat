<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ND A320</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      font-family: monospace;
      color: #0f0;
      overflow: hidden;
    }

    #overlay {
      position: absolute;
      z-index: 2;
      background: rgba(0,0,0,0.85);
      color: #0f0;
      padding: 20px;
      width: 100%;
      height: 100%;
    }

    #nd {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      height: 320px;
      border-radius: 50%;
      border: 3px solid #0f0;
      overflow: hidden;
    }

    canvas {
      width: 100%;
      height: 100%;
    }

    #info {
      position: absolute;
      top: 5px;
      right: 10px;
      color: #0f0;
      font-size: 12px;
      z-index: 3;
    }

    .text-zone {
      position: absolute;
      width: 100%;
      text-align: center;
      color: #0f0;
      font-size: 12px;
      bottom: 10px;
      z-index: 3;
    }

    .waypoint-input {
      margin-bottom: 5px;
    }

    button {
      background: black;
      border: 1px solid #0f0;
      color: #0f0;
      padding: 5px;
      font-family: monospace;
    }

    input {
      background: black;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 5px;
      font-family: monospace;
    }
  </style>
</head>
<body>

<div id="overlay">
  <h2>Navigation Display A320</h2>
  <p>Ajoute les noms des waypoints dans l‚Äôordre :</p>
  <div id="waypointContainer">
    <div class="waypoint-input"><input type="text" placeholder="Waypoint 1"></div>
  </div>
  <button onclick="addWaypointField()">‚ûï Ajouter un waypoint</button><br><br>
  <button onclick="startND()">Afficher ND</button>
  <p id="status"></p>
</div>

<div id="nd">
  <canvas id="ndCanvas" width="320" height="320"></canvas>
</div>
<div id="info"></div>
<div class="text-zone">SPD ---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HDG ---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DIST ---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TIME ---</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
  // üëâ Ta config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
    authDomain: "kykychat-24c7f.firebaseapp.com",
    databaseURL: "https://kykychat-24c7f-default-rtdb.firebaseio.com",
    projectId: "kykychat-24c7f",
    storageBucket: "kykychat-24c7f.appspot.com",
    messagingSenderId: "342562811927",
    appId: "1:342562811927:web:0fed1e1f511c4fddcfec52"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let waypoints = [];
  let userPos = null;
  let heading = 0;

  window.addEventListener("deviceorientationabsolute", (e) => {
    if (e.alpha !== null) heading = 360 - e.alpha;
  }, true);

  navigator.geolocation.watchPosition(pos => {
    userPos = {
      lat: pos.coords.latitude,
      lon: pos.coords.longitude
    };
  });

  function toRad(deg) {
    return deg * Math.PI / 180;
  }

  function addWaypointField() {
    const container = document.getElementById("waypointContainer");
    const div = document.createElement("div");
    div.className = "waypoint-input";
    div.innerHTML = `<input type="text" placeholder="Waypoint ${container.children.length + 1}">`;
    container.appendChild(div);
  }

  function drawND() {
    requestAnimationFrame(drawND);
    if (!userPos || waypoints.length === 0) return;

    const canvas = document.getElementById("ndCanvas");
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, 320, 320);
    ctx.save();
    ctx.translate(160, 160);
    ctx.rotate(-toRad(heading));

    // Rose
    ctx.strokeStyle = "#0f0";
    ctx.lineWidth = 1;
    ctx.font = "10px monospace";
    for (let h = 0; h < 360; h += 30) {
      let rad = toRad(h);
      let x = Math.sin(rad) * 140;
      let y = -Math.cos(rad) * 140;
      ctx.fillText(h.toString().padStart(3, '0'), x - 10, y + 4);
    }

    // Cercle principal
    ctx.beginPath();
    ctx.arc(0, 0, 150, 0, 2 * Math.PI);
    ctx.stroke();

    // Segments successifs
    ctx.beginPath();
    ctx.strokeStyle = "lime";
    ctx.lineWidth = 2;

    let points = [{ lat: userPos.lat, lon: userPos.lon }, ...waypoints];
    for (let i = 0; i < points.length - 1; i++) {
      let p1 = points[i];
      let p2 = points[i + 1];
      let dx1 = (p1.lon - userPos.lon) * 9000;
      let dy1 = (p1.lat - userPos.lat) * -11000;
      let dx2 = (p2.lon - userPos.lon) * 9000;
      let dy2 = (p2.lat - userPos.lat) * -11000;
      ctx.moveTo(dx1, dy1);
      ctx.lineTo(dx2, dy2);
    }
    ctx.stroke();

    // Waypoint dots
    ctx.fillStyle = "lime";
    waypoints.forEach(wp => {
      const dx = (wp.lon - userPos.lon) * 9000;
      const dy = (wp.lat - userPos.lat) * -11000;
      ctx.beginPath();
      ctx.arc(dx, dy, 3, 0, 2 * Math.PI);
      ctx.fill();
    });

    // Triangle avion
    ctx.fillStyle = "yellow";
    ctx.beginPath();
    ctx.moveTo(0, -10);
    ctx.lineTo(-7, 10);
    ctx.lineTo(7, 10);
    ctx.closePath();
    ctx.fill();

    ctx.restore();

    document.getElementById("info").innerHTML =
      `HDG ${Math.round(heading)}¬∞<br>` +
      `LAT ${userPos.lat.toFixed(4)}<br>LON ${userPos.lon.toFixed(4)}`;
  }

  async function startND() {
    const inputs = document.querySelectorAll("#waypointContainer input");
    waypoints = [];
    for (let input of inputs) {
      const name = input.value.trim().toUpperCase();
      if (!name) continue;
      const doc = await db.collection("waypoints").doc(name).get();
      if (doc.exists) {
        waypoints.push(doc.data());
      } else {
        document.getElementById("status").innerText = `‚ùå ${name} introuvable`;
        return;
      }
    }
    document.getElementById("overlay").style.display = "none";
    drawND();
  }
</script>

</body>
</html>
