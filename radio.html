<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Radio WebRTC</title>
    <style>
        body { background: #111; color: white; text-align: center; font-family: Arial, sans-serif; }
        #pttBtn { padding: 15px 30px; background: #2b2; border: none; border-radius: 10px; font-size: 18px; cursor: pointer; margin-top: 20px; }
        #pttBtn:active { background: #e33; }
    </style>
</head>
<body>
    <h1>Radio WebRTC</h1>
    <audio id="remoteAudio" autoplay></audio>
    <button id="pttBtn">Push-to-Talk</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, push, onChildAdded, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDDH3yMEr78C_h0yAMiEXYVtENmiwMbxas",
            authDomain: "kykychat-24c7f.firebaseapp.com",
            databaseURL: "https://kykychat-24c7f-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "kykychat-24c7f",
            storageBucket: "kykychat-24c7f.appspot.com",
            messagingSenderId: "248801360563",
            appId: "1:248801360563:web:bdd019dd49805236c84310"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const userId = prompt("Votre indicatif ?");
        const pttBtn = document.getElementById("pttBtn");
        const remoteAudio = document.getElementById("remoteAudio");

        let localStream;
        let peerConnection;

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                localStream = stream;
                localStream.getAudioTracks()[0].enabled = false; // Micro coupé par défaut
                announcePresence();
            })
            .catch(err => console.error("Erreur accès micro:", err));

        function announcePresence() {
            set(ref(db, `radio/users/${userId}`), true);
            listenForOffers();
        }

        function listenForOffers() {
            onChildAdded(ref(db, "radio/offers"), async snapshot => {
                const data = snapshot.val();
                if (data.to === userId) {
                    peerConnection = new RTCPeerConnection();

                    peerConnection.onicecandidate = e => {
                        if (e.candidate) push(ref(db, `radio/candidates/${data.from}/${userId}`), JSON.stringify(e.candidate));
                    };

                    peerConnection.ontrack = e => {
                        remoteAudio.srcObject = e.streams[0];
                    };

                    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    set(ref(db, `radio/answers/${data.from}`), { from: userId, answer });

                    listenForCandidates(data.from);
                }
            });
        }

        function call(target) {
            peerConnection = new RTCPeerConnection();

            peerConnection.onicecandidate = e => {
                if (e.candidate) push(ref(db, `radio/candidates/${userId}/${target}`), JSON.stringify(e.candidate));
            };

            peerConnection.ontrack = e => {
                remoteAudio.srcObject = e.streams[0];
            };

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.createOffer()
                .then(offer => {
                    peerConnection.setLocalDescription(offer);
                    set(ref(db, `radio/offers/${userId}`), { from: userId, to: target, offer });
                    listenForCandidates(target);
                });

            onValue(ref(db, `radio/answers/${userId}`), snapshot => {
                const data = snapshot.val();
                if (data && data.from === target) {
                    peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
            });
        }

        function listenForCandidates(otherId) {
            onChildAdded(ref(db, `radio/candidates/${otherId}/${userId}`), snap => {
                const candidate = JSON.parse(snap.val());
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            });
        }

        // Push-to-Talk
        pttBtn.onpointerdown = () => {
            if (localStream) localStream.getAudioTracks()[0].enabled = true;
            pttBtn.style.background = "#e33";
        };

        pttBtn.onpointerup = () => {
            if (localStream) localStream.getAudioTracks()[0].enabled = false;
            pttBtn.style.background = "#2b2";
        };

        // Appel automatique sur clic utilisateur distant (simulé)
        onChildAdded(ref(db, "radio/users"), snap => {
            const targetId = snap.key;
            if (targetId !== userId) call(targetId);
        });
    </script>
</body>
</html>
