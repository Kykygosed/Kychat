<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Radio Minecraft</title>
    <style>
        body { background: #555; color: orange; font-family: Arial, sans-serif; text-align: center; }
        #display { background: black; color: orange; font-size: 60px; padding: 10px; margin: 20px auto; width: 300px; border-radius: 10px; }
        #freq-list { background: #6cf; color: orange; padding: 10px; text-align: left; position: absolute; top: 10px; left: 10px; width: 200px; border-radius: 5px; }
        #keypad button { font-size: 30px; margin: 5px; padding: 10px 20px; }
        #ptt { background: red; color: darkred; font-size: 25px; padding: 20px; border-radius: 50%; margin: 20px; cursor: pointer; }
        #ptt.active { background: green; color: white; }
        #ptt.disabled { background: grey; color: darkred; cursor: not-allowed; }
        #device-select { margin: 10px; }
        #users { color: white; margin-top: 20px; }
        #start-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        #start-screen button { font-size: 25px; padding: 15px 30px; margin-top: 20px; }
        #main-content { display: none; }
    </style>
</head>
<body>

<div id="start-screen">
    <h1>Bienvenue sur la Radio Minecraft</h1>
    <p>Appuyez ci-dessous pour autoriser le micro et commencer</p>
    <button id="start-btn">Autoriser le micro</button>
</div>

<div id="main-content">
    <div id="freq-list">
        <b>Liste des fréquences importantes:</b><br>
        153.890 - KLTA_TOWER<br>
        153.750 - KLTA_ATIS<br>
        153.310 - UNICOM
    </div>

    <div id="display">123.450</div>

    <select id="device-select"></select>
    <button id="initMic">Activer le Micro</button>
    <label for="outputSelect">Sortie Audio :</label>
    <select id="outputSelect"></select>

    <div id="keypad">
        <button>1</button><button>2</button><button>3</button><button>4</button><button>5</button><br>
        <button>6</button><button>7</button><button>8</button><button>9</button><button>0</button>
        <button>.</button>
        <button id="go">GO</button>
    </div>

    <button id="ptt" class="disabled">PTT</button>

    <div id="users">Connectés: <span id="user-list"></span></div>

    <audio id="noise" src="noise.mp3"></audio>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDyWu4TI4PIRXfeb7yqt0WIGClgu10IjkM",
  authDomain: "kylita-f2923.firebaseapp.com",
  projectId: "kylita-f2923",
  storageBucket: "kylita-f2923.appspot.com",
  messagingSenderId: "431823530994",
  appId: "1:431823530994:web:88a07e633751686e5ad96b",
  measurementId: "G-F4LLNWQJ16",
  databaseURL: "https://kylita-f2923-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let localStream;
let peerConnections = {};
let currentFreq = "123.450";
let isTalking = false;
let userId = "user_" + Math.floor(Math.random() * 10000);

const display = document.getElementById("display");
const ptt = document.getElementById("ptt");
const keypad = document.getElementById("keypad");
const go = document.getElementById("go");
const deviceSelect = document.getElementById("device-select");
const noise = document.getElementById("noise");
const userList = document.getElementById("user-list");
const startScreen = document.getElementById("start-screen");
const startBtn = document.getElementById("start-btn");
const mainContent = document.getElementById("main-content");
const initMicBtn = document.getElementById("initMic");
const outputSelect = document.getElementById("outputSelect");



startBtn.onclick = async () => {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localStream.getTracks().forEach(t => t.stop());
        startScreen.style.display = "none";
        mainContent.style.display = "block";
        initApp();
    } catch (err) {
        alert("Vous devez autoriser le micro pour utiliser la radio.");
    }
};

function initApp() {
    navigator.mediaDevices.enumerateDevices().then(devices => {
        devices.filter(d => d.kind === 'audioinput').forEach(d => {
            let opt = document.createElement("option");
            opt.value = d.deviceId;
            opt.textContent = d.label || "Micro ";
            deviceSelect.appendChild(opt);
        });
    });
initMicBtn.onclick = async () => {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: { deviceId: deviceSelect.value } });
        console.log("Micro activé.");
        initMicBtn.disabled = true;
    } catch (err) {
        console.error("Erreur d'activation du micro :", err);
    }
};
navigator.mediaDevices.enumerateDevices().then(devices => {
    devices.forEach(device => {
        if (device.kind === 'audiooutput') {
            const option = document.createElement("option");
            option.value = device.deviceId;
            option.text = device.label || `Sortie ${outputSelect.length + 1}`;
            outputSelect.appendChild(option);
        }
    });
});
    outputSelect.onchange = () => {
    const selectedOutput = outputSelect.value;
    document.querySelectorAll("audio").forEach(audioElem => {
        if (typeof audioElem.setSinkId === 'function') {
            audioElem.setSinkId(selectedOutput).then(() => {
                console.log(`Sortie audio définie sur ${selectedOutput}`);
            }).catch(err => {
                console.warn("Impossible de définir la sortie :", err);
            });
        } else {
            console.warn("setSinkId non supporté par ce navigateur.");
        }
    });
};

    let freqInput = "";
    keypad.addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON' && e.target.textContent !== "GO") {
            freqInput += e.target.textContent;
            display.textContent = freqInput;
        }
    });

    go.onclick = () => {
        if (freqInput.length > 0) {
            leaveFreq(currentFreq);
            currentFreq = freqInput;
            joinFreq(currentFreq);
            display.textContent = currentFreq;
            freqInput = "";
        }
    };

    ptt.onmousedown = startTalk;
    ptt.ontouchstart = startTalk;
    ptt.onmouseup = stopTalk;
    ptt.ontouchend = stopTalk;

    joinFreq(currentFreq);
}

function startTalk() {
    db.ref(`freq/${currentFreq}/talking`).once('value', snap => {
        if (!snap.val()) {
            db.ref(`freq/${currentFreq}/talking`).set(userId);
            ptt.classList.add("active");
            isTalking = true;
            startStream().then(() => {
                for (let peerId in peerConnections) {
                    const pc = peerConnections[peerId];
                    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                }
            });
        }
    });
}

function stopTalk() {
    if (isTalking) {
        db.ref(`freq/${currentFreq}/talking`).set("");
        ptt.classList.remove("active");
        stopStream();
        noise.play();
        isTalking = false;
    }
}

function joinFreq(freq) {
    db.ref(`freq/${freq}/talking`).on('value', snap => {
        const speaker = snap.val();
        if (speaker && speaker !== userId) {
            ptt.classList.add("disabled");
        } else {
            ptt.classList.remove("disabled");
        }
    });

    db.ref(`freq/${freq}/users/${userId}`).set(true);
    db.ref(`freq/${freq}/users/${userId}`).onDisconnect().remove();
    db.ref(`freq/${freq}/users`).on('value', snap => {
        const users = Object.keys(snap.val() || {});
        userList.textContent = users.join(", ");
        users.forEach(uid => {
            if (uid !== userId && !peerConnections[uid]) {
                createPeerConnection(uid);
            }
        });
    });
}

function leaveFreq(freq) {
    db.ref(`freq/${freq}/talking`).off();
    db.ref(`freq/${freq}/users/${userId}`).remove();
    db.ref(`freq/${freq}/users`).off();
    for (let uid in peerConnections) {
        peerConnections[uid].close();
        delete peerConnections[uid];
    }
}

async function startStream() {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: { deviceId: deviceSelect.value } });
}

function stopStream() {
    if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
    }
}

function createPeerConnection(peerId) {
    const pc = new RTCPeerConnection();
    peerConnections[peerId] = pc;

    pc.ontrack = (e) => {
        const audio = new Audio();
        audio.srcObject = e.streams[0];
        audio.play();
    };

    pc.onicecandidate = (e) => {
        if (e.candidate) {
            db.ref(`signals/${currentFreq}/${peerId}/candidates/${userId}`).push(JSON.stringify(e.candidate));
        }
    };

    db.ref(`signals/${currentFreq}/${userId}/offer`).on('value', async snap => {
        const data = snap.val();
        if (data && !pc.currentRemoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(data)));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            db.ref(`signals/${currentFreq}/${userId}/answer`).set(JSON.stringify(answer));
        }
    });

    db.ref(`signals/${currentFreq}/${userId}/candidates/${peerId}`).on('child_added', snap => {
        pc.addIceCandidate(new RTCIceCandidate(JSON.parse(snap.val())));
    });

    pc.createOffer().then(offer => {
        pc.setLocalDescription(offer);
        db.ref(`signals/${currentFreq}/${peerId}/offer`).set(JSON.stringify(offer));
    });

    db.ref(`signals/${currentFreq}/${peerId}/answer`).on('value', async snap => {
        const data = snap.val();
        if (data && !pc.currentRemoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(data)));
        }
    });

    db.ref(`signals/${currentFreq}/${peerId}/candidates/${userId}`).on('child_added', snap => {
        pc.addIceCandidate(new RTCIceCandidate(JSON.parse(snap.val())));
    });
}
</script>
</body>
</html>
