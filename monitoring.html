<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Monitoring Cam√©ras</title>
<style>
    body {
        background: black;
        margin: 0;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(4, 1fr);
        height: 100vh;
        width: 100vw;
    }
    .cam {
        position: relative;
        background: #111;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        cursor: pointer;
    }
    .cam video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: grayscale(100%);
    }
    .cam .no-data {
        color: white;
        font-family: monospace;
        font-size: 1.2rem;
    }
    .zoom {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 10;
        background: black;
    }
    .zoom video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
  authDomain: "kykychat-24c7f.firebaseapp.com",
  databaseURL: "https://kykychat-24c7f-default-rtdb.firebaseio.com",
  projectId: "kykychat-24c7f",
  storageBucket: "kykychat-24c7f.firebasestorage.app",
  messagingSenderId: "342562811927",
  appId: "1:342562811927:web:0fed1e1f511c4fddcfec52"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const gridSize = 16;
const cams = [];
const peerConnections = {};
const streams = {};
const camElements = [];

for (let i = 0; i < gridSize; i++) {
    const div = document.createElement('div');
    div.className = 'cam';
    div.innerHTML = `<div class="no-data">NO DATA</div>`;
    document.body.appendChild(div);
    camElements.push(div);

    div.onclick = () => {
        if (div.classList.contains('zoom')) {
            div.classList.remove('zoom');
        } else {
            camElements.forEach(el => el.classList.remove('zoom'));
            div.classList.add('zoom');
        }
    };
}

database.ref('signals').on('value', snap => {
    const cameras = snap.val() || {};
    const camIds = Object.keys(cameras);

    camIds.forEach((camId, index) => {
        if (index >= gridSize) return;
        if (streams[camId]) return;

        const pc = new RTCPeerConnection();
        peerConnections[camId] = pc;

        const div = camElements[index];
        div.innerHTML = '';

        const video = document.createElement('video');
        video.autoplay = true;
        video.playsInline = true;
        div.appendChild(video);

        pc.ontrack = e => {
            video.srcObject = e.streams[0];
            streams[camId] = e.streams[0];
        };

        pc.onicecandidate = event => {
            if (event.candidate) return;
        };

        (async () => {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            const viewerId = 'viewer-' + Math.random().toString(36).substr(2, 9);

            database.ref('signals/' + camId).push({
                type: 'offer',
                offer: pc.localDescription,
                viewerId
            });

            database.ref('answers/' + viewerId).on('value', async snap => {
                const data = snap.val();
                if (data && data.answer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    database.ref('answers/' + viewerId).remove();
                }
            });
        })();
    });

    for (let i = camIds.length; i < gridSize; i++) {
        if (!camElements[i].querySelector('.no-data')) {
            camElements[i].innerHTML = `<div class="no-data">NO DATA</div>`;
        }
    }
});
</script>

</body>
</html>
