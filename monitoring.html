<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Monitoring Cam√©ras</title>
<style>
    body {
        background: black;
        margin: 0;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(4, 1fr);
        height: 100vh;
        width: 100vw;
    }
    .cam {
        position: relative;
        background: #111;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        cursor: pointer;
    }
    .cam video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: grayscale(100%);
    }
    .cam .no-data {
        color: white;
        font-family: monospace;
        font-size: 1.2rem;
    }
    .zoom {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 10;
        background: black;
    }
    .zoom video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
    authDomain: "kykychat-24c7f.firebaseapp.com",
    databaseURL: "https://kykychat-24c7f-default-rtdb.firebaseio.com",
    projectId: "kykychat-24c7f",
    storageBucket: "kykychat-24c7f.appspot.com",
    messagingSenderId: "342562811927",
    appId: "1:342562811927:web:0fed1e1f511c4fddcfec52"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const viewerId = 'viewer-' + Math.random().toString(36).substr(2, 9);

function monitorCameras() {
    const grid = document.getElementById('grid');
    
    database.ref('signals').on('value', snapshot => {
        grid.innerHTML = ''; // Clear grid

        const cams = snapshot.val();
        const camList = cams ? Object.keys(cams) : [];

        for (let i = 0; i < 16; i++) {
            const cell = document.createElement('div');
            cell.style.flex = '1 0 25%';
            cell.style.aspectRatio = '16/9';
            cell.style.border = '1px solid gray';
            cell.style.position = 'relative';
            cell.style.background = 'black';
            cell.style.overflow = 'hidden';

            if (i < camList.length) {
                const camId = camList[i];
                const video = document.createElement('video');
                video.autoplay = true;
                video.muted = true;
                video.style.filter = 'grayscale(100%)';
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'cover';
                
                cell.appendChild(video);
                setupConnection(camId, video);

                // Agrandissement au clic
                cell.onclick = () => {
                    if (cell.style.position === 'fixed') {
                        cell.style = '';
                        monitorCameras();
                    } else {
                        Array.from(grid.children).forEach(c => c.style.display = 'none');
                        cell.style.position = 'fixed';
                        cell.style.top = '0';
                        cell.style.left = '0';
                        cell.style.width = '100%';
                        cell.style.height = '100%';
                        cell.style.zIndex = '10';
                        cell.style.background = 'black';
                    }
                };

            } else {
                const txt = document.createElement('div');
                txt.innerText = 'NO DATA';
                txt.style.color = 'white';
                txt.style.fontFamily = 'monospace';
                txt.style.fontSize = '20px';
                txt.style.display = 'flex';
                txt.style.alignItems = 'center';
                txt.style.justifyContent = 'center';
                txt.style.height = '100%';
                cell.appendChild(txt);
            }

            grid.appendChild(cell);
        }
    });
}

function setupConnection(camId, videoElement) {
    const pc = new RTCPeerConnection();
    pc.ontrack = (e) => {
        videoElement.srcObject = e.streams[0];
    };

    pc.onicecandidate = e => {
        if (e.candidate) return;
        database.ref('signals/' + camId + '/' + viewerId).set({
            type: 'offer',
            offer: pc.localDescription,
            viewerId: viewerId
        });
    };

    pc.addTransceiver('video', { direction: 'recvonly' });

    pc.createOffer().then(offer => {
        return pc.setLocalDescription(offer);
    }).catch(console.error);

    database.ref('answers/' + viewerId).on('value', snap => {
        const data = snap.val();
        if (data && data.answer) {
            pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
    });
}

monitorCameras();

</script>

</body>
</html>
