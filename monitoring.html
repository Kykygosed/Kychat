<!DOCTYPE html>
<html>
<head>
    <title>Monitoring</title>
    <style>
        body { margin: 0; background: black; display: flex; flex-wrap: wrap; width: 100vw; height: 100vh; }
        .cell { flex: 1 0 25%; aspect-ratio: 16/9; border: 1px solid gray; position: relative; background: black; overflow: hidden; }
        .cell video { width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%); }
        .nodata { color: white; font-family: monospace; display: flex; align-items: center; justify-content: center; height: 100%; }
    </style>
</head>
<body>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
    authDomain: "kykychat-24c7f.firebaseapp.com",
    databaseURL: "https://kykychat-24c7f-default-rtdb.firebaseio.com",
    projectId: "kykychat-24c7f",
    storageBucket: "kykychat-24c7f.appspot.com",
    messagingSenderId: "342562811927",
    appId: "1:342562811927:web:0fed1e1f511c4fddcfec52"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const viewerId = 'viewer-' + Math.random().toString(36).substr(2, 9);

function refreshGrid() {
    document.body.innerHTML = '';
    db.ref('signals').once('value', snap => {
        const cams = snap.val();
        const camList = cams ? Object.keys(cams) : [];
        
        for (let i = 0; i < 16; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            document.body.appendChild(cell);

            if (i < camList.length) {
                const camId = camList[i];
                const video = document.createElement('video');
                video.autoplay = true;
                video.muted = true;
                cell.appendChild(video);
                connectToCam(camId, video);

                cell.onclick = () => {
                    if (cell.style.position === 'fixed') refreshGrid();
                    else {
                        document.body.innerHTML = '';
                        cell.style.position = 'fixed';
                        cell.style.top = 0;
                        cell.style.left = 0;
                        cell.style.width = '100%';
                        cell.style.height = '100%';
                        cell.style.zIndex = 10;
                        document.body.appendChild(cell);
                    }
                };
            } else {
                const txt = document.createElement('div');
                txt.className = 'nodata';
                txt.innerText = 'NO DATA';
                cell.appendChild(txt);
            }
        }
    });
}

function connectToCam(camId, video) {
    const pc = new RTCPeerConnection();
    pc.ontrack = e => video.srcObject = e.streams[0];

    pc.onicecandidate = e => {
        if (e.candidate) return;
        db.ref('signals/' + camId + '/' + viewerId).set({
            type: 'offer',
            offer: pc.localDescription,
            viewerId: viewerId
        });
    };

    pc.addTransceiver('video', { direction: 'recvonly' });
    pc.createOffer().then(o => pc.setLocalDescription(o));

    db.ref('answers/' + viewerId).on('value', snap => {
        const data = snap.val();
        if (data && data.answer) {
            pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
    });
}

refreshGrid();
setInterval(refreshGrid, 5000); // Refresh grid every 5s to detect new cams
</script>
</body>
</html>
